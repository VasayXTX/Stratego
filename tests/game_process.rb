#coding: utf-8

require File.join(File.dirname(__FILE__), 'game_helper')

t = Tester.new(CLIENTS_NUM) { |i| ["User#{i}", 'password'] }

M = h_slice(Generator::MAP_MINI, %w[name width height])
M['obst'] = Generator::MAP_MINI['structure']['obst']
MAP_SIZE = M['width'] * M['height']


class GameProcess
  def initialize(pl_placement, opp_placement)
    @pl_placement = pl_placement
    @opp_placement = opp_placement
    @turn = :pl
  end

  def make_move(p_from, p_to)
    req, r = GameProcess.make_cmd(p_from, p_to)

    if @turn == :pl
      @turn = :opp
      placement = @pl_placement
      sender = 0
    else
      @turn = :pl
      p_from = MAP_SIZE - p_from - 1
      p_to = MAP_SIZE - p_to - 1
      placement = @opp_placement
      sender = 1
    end
    placement[p_to.to_s] = placement[p_from.to_s]
    placement.delete(p_from.to_s)

     resp = { sender => { 'status' => 'ok' } }
     resp[(sender + 1) % 2] = r

    _req = { 'cmd' => 'getGame' }
    _resp = get_game

    [
      [sender, req, resp],
      [0, _req, _resp[0]],
      [1, _req, _resp[1]],
    ]
  end

  def self.make_cmd(p_from, p_to)
    [
      {
        'cmd' => 'makeMove',
        'posFrom' => p_from,
        'posTo' => p_to
      },
      {
        'cmd' => 'makeMove',
        'posFrom' => MAP_SIZE - p_from - 1,
        'posTo' => MAP_SIZE - p_to - 1
      }
    ]
  end

  def get_game
    res = Array.new(2) do |i|
      {
        i => {
          'status' => 'ok',
          'game_name' => GAME_MINI,
          'players' => %w[User0 User1],
          'army' => Generator::ARMY_MINI,
        }
      }
    end
    
    res[0][0].merge!(
      'map' => M,
      'isTurn' => @turn == :pl,
      'state' => {
        'pl1' => clone(@pl_placement),
        'pl2' => clone(@opp_placement.keys.map { |el| el.to_i })
      }
    )
    
    m = clone(M)
    m['obst'] = reflect_a(m['obst'], MAP_SIZE)
    res[1][1].merge!(
      'map' => m,
      'isTurn' => @turn == :opp,
      'state' => {
        'pl1' => reflect_placement(@opp_placement, MAP_SIZE),
        'pl2' => reflect_a(
          @pl_placement.keys.map { |el| el.to_i },
          MAP_SIZE
        )
      }
    )

    res
  end
end

game_process = GameProcess.new(
  Generator::make_tactic(Generator::TACTIC_TEST),
  reflect_placement(
    Generator::make_tactic(Generator::TACTIC_TEST), MAP_SIZE)
)

#Test1
#--------------------------------
auth(t)

#Test2 
#--------------------------------
t.push_test(initial_game_test)

#Test3
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)| M(7)| C(6)| L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |  &  |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |  *  |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |S(2) |L(5) |C(6) |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

resp = {
  1 => {
    'status' => 'badAction',
    'message' => 'Game isn\'t started'
  }
}
t.push_test([[1, GameProcess.make_cmd(8, 20)[0], resp]])

#Test4
#--------------------------------
req = {
  'cmd' => 'setPlacement',
  'placement' => Generator.make_tactic(Generator::TACTIC_TEST)
}
resp0 = {
  1 => {
    'status' => 'ok',
    'isGameStarted' => false
  },
  0 => { 'cmd' => 'readyOpponent' }
}
resp1 = {
  0 => {
    'status' => 'ok',
    'isGameStarted' => true
  },
  1 => { 'cmd' => 'startGame' }
}
t.push_test([
  [1, req, resp0],
  [0, req, resp1]
])

#Test5
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)| M(7)| C(6)| L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |  &  |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |  *  |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |S(2) |L(5) |C(6) |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

resp = {
  1 => {
    'status' => 'badAction',
    'message' => 'It isn\'t your turn now'
  }
}
t.push_test([[1, GameProcess.make_cmd(8, 20)[0], resp]])

#Test5 (bad positions)
#--------------------------------
resp = {
  0 => {
    'status' => 'badMove',
    'message' => 'Incorrect move'
  }
}
test = [
  [-1, 0],
  [48, 47],
  [0, -1],
  [47, 48],
  [13, 14],
  [1, 2],
  [0, 12],
].map { |el| [0, GameProcess.make_cmd(el[0], el[1])[0], resp] }
t.push_test(test)

#Test6 (bad lenght of the move)
#--------------------------------
resp = {
  0 => {
    'status' => 'badMove',
    'message' => 'Incorrect move'
  }
}
test = [
  [0, 13],
  [1, 13],
  [2, 14],
  [3, 27],
  [4, 15],
  [6, 30]
].map { |el| [0, GameProcess.make_cmd(el[0], el[1])[0], resp] }
t.push_test(test)

#--------------------------------------------------------------------------
cl0_pl1 = Generator::make_tactic(Generator::TACTIC_TEST)
cl1_pl1 = clone(cl0_pl1)

#Test7 (pl1)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)| M(7)| C(6)| L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |     |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |  &  |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |  *  |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |S(2) |L(5) |C(6) |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(5, 17))

#Test8 (pl2)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)| M(7)| C(6)| L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |     |     |  *  |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |  &  |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |L(5) |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |S(2) |     |C(6) |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(6, 18))

#Test9 (pl1)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)| M(7)|     | L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |     |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     | C(6)|     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |  &  |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |L(5) |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |  *  |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |S(2) |     |C(6) |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(6, 18))

#Test10 (pl2)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)| M(7)|     | L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |     |  *  |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     | C(6)|     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |  &  |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |L(5) |C(6) |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |S(2) |     |     |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(7, 19))

#Test11 (pl1)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)|     |     | L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |     |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     | M(7)| C(6)|     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |  *  |  &  |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |L(5) |C(6) |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |S(2) |     |     |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(18, 19))

#Test12 (pl2)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)|     |     | L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |     |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     | M(7)| C(6)|     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |  *  |  &  |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |L(5) |     |C(6) |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |S(2) |     |     |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(18, 17))

#Test13 (pl1)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)|     |     | L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |     |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     | M(7)|     | C(6)|     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |L(5) |     |C(6) |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |  *  |     |  &  |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |S(2) |     |     |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(4, 6))

#Test14 (pl2)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|M(10)|     |     | L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |  *  |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     | M(7)|     | C(6)|     |     |     |     |xxxxx|
  |xxxxx|     |     |  &  |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |L(5) |     |C(6) |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |     |     |S(2) |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(8, 20))

#Test15 (pl1)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|     |     |     | L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |     |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |M(10)| M(7)|     | C(6)|     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |  &  |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |L(5) |     |C(6) |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |  *  |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|S(1) |     |     |S(2) |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(3, 15))

#Test16 (pl2)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)| G(9)| M(3)|     |     |     | L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |  *  |     |     |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |M(10)| M(7)|     | C(6)|     |     |     |     |xxxxx|
  |xxxxx|  &  |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  |xxxxx|     |     |S(1) |     |L(5) |     |C(6) |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|     |     |     |S(2) |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(10, 22))

#Test17 (pl1)
#--------------------------------
=begin

    11    10     9     8     7     6     5     4     3     2     1     0 
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  | C(8)|     | M(3)|     |     |     | L(5)| S(2)| S(1)|B(-1)| F(0)| S(4)|
  |     |     |     |     |     |     |     |     |     |     |     |     |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx| G(9)|     |M(10)| M(7)|     | C(6)|  &  |     |     |     |xxxxx|
  |xxxxx|     |     |     |     |     |     |     |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |xxxxx|     |     |     |     |     |     |  *  |     |     |     |xxxxx|
  |xxxxx|     |     |S(1) |     |L(5) |     |C(6) |     |     |     |xxxxx|
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
  |     |     |     |     |     |     |     |     |     |     |     |     |
  |S(4) |F(0) |B(-1)|     |     |     |S(2) |M(7) |M(10)|M(3) |G(9) |C(8) |
  +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
     0     1     2     3     4     5     6     7     8     9     10    11 

=end

t.push_test(game_process.make_move(19, 31))

#Test
#--------------------------------
logout(t)

t.run

